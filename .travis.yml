language: C
git:
  depth: 9999999
os:
- linux
compiler:
- clang
matrix:
  include:
  - os: osx
    compiler: clang
    env: VERS=macos DEPLOY=yes
  - os: linux
    compiler: gcc
    env: VERS=win DEPLOY=yes
  - os: linux
    compiler: gcc
    env: VERS=linux DEPLOY=yes
dist: trusty
sudo: required
branches:
  only: master
install: |-
  if [ "$VERS" == "win" ] # Cross compiling for Windows
  then
    sudo add-apt-repository "deb http://fr.archive.ubuntu.com/ubuntu/ xenial main restricted universe multiverse" # We need an up-to-date MinGW
    sudo apt-get update
    sudo apt-get -qy install libsdl2-dev rpm libegl1-mesa-dev libgles2-mesa-dev libxi-dev libxrandr-dev freeglut3
    sudo apt-get install -t xenial gcc-mingw-w64-i686 g++-mingw-w64-i686 mingw32-runtime
  elif [ "$VERS" == "linux" ]
  then
    sudo apt-get -qy install libsdl2-dev rpm libegl1-mesa-dev libgles2-mesa-dev libxi-dev libxrandr-dev freeglut3  # freeglut probably pulls libxi-dev in
  elif [ "$VERS" == "macos" ]
  then
    echo "Building macOS"
    brew install sdl2
  fi
script: |-
  if [ "$VERS" == "win" ]
  then
    ./makecrosswin.sh || exit 1
  elif [ "$VERS" == "linux" ]
  then
    if [ "$CXX" == "g++" ]; then export CXX="g++-6" CC="gcc-6"; fi
    ./makelinux.sh || exit 1
  elif [ "$VERS" == "macos" ]
  then
    if [ "$CXX" == "g++" ]; then export CXX="g++-6" CC="gcc-6"; fi
    ./makemacos.sh || exit 1
  fi
before_deploy: |-
  if [ "$VERS" == "macos" ]
  then
    export DEPLOY_BIN=fbvpdf-macos.zip
    export DEPLOY_PKG=fbvpdf.dmg
  elif [ "$VERS" == "win" ]
  then
    export DEPLOY_BIN=build/release/mupdf-win.exe
    export DEPLOY_PKG=fbvpdf.zip
  elif [ "$VERS" == "linux" ]
  then
    export DEPLOY_BIN=build/release/mupdf-linux
    export DEPLOY_PKG=fbvpdf.tar.gz
  fi
deploy:
  provider: releases
  api_key:
    secure: Zycsz5dcLWS1ZEXEHxNEq4BgaB1h/wQAREqPEB3VuhXQehz9ImsU5SXT/fxvcBLRJh5oHbnBhU5RP4Ef1z58IPIsrD7XC5i6YghpvYNlP2h9pv59Il33W8nFyEL7O5XM3Yhi4zhK9YyG0tyd+d4MiyLm0DBgem4BzR3xzzODbyp9YubMn3t+F1eDUXdpWfiMUYgUXF6rnXgRZR/bIj8xllxSyIa9D63JrLIr1hI2J6WOWBcDVlrkBpQ+4x+OV8+6Dz2bFQ6QXFnmZc01xxERVmKXGn8TePFGkEr9e+dpT8q3qAEb/0z7cRSKR7HuSXdMVb63yjPnNPuJDfU+JIx2YjdtTP8a13OKqQTPvYxBDOVm8xl5KGg/PI6OLLIuhN8lYJLRn8epd8pn9SuFDI2d4O61jrdY5aa3/9GkAxkYrtfYsFkDVDRzdFux/bHW+ch4GFh07Afz/zeI3cAX6L4bqBkdIGjT/xjwglyjNftMpIaFQqzi4xHQ0yzu0Br8/IZ1Y0273XZA+rsBWh5JKNsuPsYB2wi5XNmBuRAALzPPUYadE+W3XfX4cMOe22hexlms5n4t3JcctoZnyoH58W93SkfPkpFiSbkyt5keSywZSK4eo4S7KArhTxf/wEobqwIgdTQefp+6HZtp1JipyvwSXg83rFPMNtVcee/Glux1mH4=
  file:
    - "${DEPLOY_BIN}"
    - "${DEPLOY_PKG}"
  skip_cleanup: true
  on:
    repo: pvtinflex/fbvpdf
